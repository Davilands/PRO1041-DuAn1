USE master

CREATE DATABASE DAVISY
USE DAVISY

CREATE TABLE LOAIHANG(
	MALH NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENLH NVARCHAR(50) NOT NULL
)

CREATE TABLE HANG(
	MAHANG NVARCHAR(10) NOT NULL PRIMARY KEY,
	TEHANG NVARCHAR(50) NOT NULL,
)

CREATE TABLE SANPHAM(
	MASP NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENSP NVARCHAR(50) NOT NULL,
	MALH NVARCHAR(10) NOT NULL,
	MAHANG NVARCHAR(10) NOT NULL,
	GIANHAP FLOAT NOT NULL,
	GIABAN FLOAT NOT NULL,
	NGAYNHAP DATE NOT NULL,
	HINH NVARCHAR(50) NOT NULL,
	MOTA NVARCHAR(100) NOT NULL
)

CREATE TABLE KHACHHANG(
	MAKH NVARCHAR(10) NOT NULL PRIMARY KEY,
	HOTEN NVARCHAR(50) NOT NULL,
	DIENTHOAI NVARCHAR(20) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	TICHDIEM INT NOT NULL
)

CREATE TABLE HOADON(
	MAHD NVARCHAR(10) NOT NULL PRIMARY KEY,
	TENDN NVARCHAR(50) NOT NULL,
	MAKH NVARCHAR(10) NOT NULL,
	MAGH NVARCHAR(10) NOT NULL,
	TENSP NVARCHAR(50) NOT NULL,
	NGAYLAP DATE NOT NULL,
	SOLUONG INT NOT NULL,
	GIABAN FLOAT NOT NULL,
	THANHTIEN FLOAT NOT NULL,
	TRUTIENTICHDIEM FLOAT NOT NULL,
	PHANTRAMGG FLOAT NOT NULL,
	TONGTIEN FLOAT NOT NULL,
	TIENMAT FLOAT NOT NULL,
	TRALAIKHACH FLOAT NOT NULL
)

CREATE TABLE CHITIETHOADON(
	MAHD NVARCHAR(10) NOT NULL,
	MASP NVARCHAR(10) NOT NULL,
	MAHANG NVARCHAR(10) NOT NULL,
	MALH NVARCHAR(10) NOT NULL,
	NGAYLAP DATE NOT NULL,
	TENSP NVARCHAR(50) NOT NULL,
	TENHANG NVARCHAR(50) NOT NULL,
	TENLH NVARCHAR(50) NOT NULL,
	NGAYNHAP DATE NOT NULL,
	GIANHAP FLOAT NOT NULL,
	GIABAN FLOAT NOT NULL,
	SOLUONG INT NOT NULL,
	TRUTIENTICHDIEM FLOAT NOT NULL,
	PHANTRAMGG FLOAT NOT NULL,
)

CREATE TABLE GIOHANG(
	MAGH NVARCHAR(10) NOT NULL PRIMARY KEY,
	MASP NVARCHAR(10) NOT NULL,
	MAKH NVARCHAR (10) NOT NULL,
	TENDN NVARCHAR(50) NOT NULL,
	SOLUONG INT NOT NULL,
	TONGTIEN FLOAT NOT NULL
)

CREATE TABLE CHUCVU(
	MACV INT NOT NULL PRIMARY KEY,
	TENCV NVARCHAR(50) NOT NULL,
)

CREATE TABLE TAIKHOAN(
	TENDN NVARCHAR(50) NOT NULL PRIMARY KEY,
	MACV INT NOT NULL,
	TENNV NVARCHAR(50) NOT NULL,
	EMAIL NVARCHAR(50) NOT NULL,
	MATKHAU NVARCHAR(50) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	DIENTHOAI NVARCHAR(50) NOT NULL,
	NGAYSINH DATE NOT NULL,
	GIOITINH BIT NOT NULL,
	TRANGTHAI BIT NOT NULL
)

ALTER TABLE SANPHAM ADD CONSTRAINT FK_SANPHAM_LOAIHANG FOREIGN KEY (MALH) REFERENCES LOAIHANG(MALH);
ALTER TABLE SANPHAM ADD CONSTRAINT FK_SANPHAM_HANG FOREIGN KEY (MAHANG) REFERENCES HANG(MAHANG);

ALTER TABLE GIOHANG ADD CONSTRAINT FK_GIOHANG_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP);
ALTER TABLE CHITIETHOADON ADD CONSTRAINT FK_CTHD_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP);

ALTER TABLE GIOHANG ADD CONSTRAINT FK_GIOHANG_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH);
ALTER TABLE HOADON ADD CONSTRAINT FK_HOADON_GIOHANG FOREIGN KEY (MAGH) REFERENCES GIOHANG(MAGH);
ALTER TABLE GIOHANG ADD CONSTRAINT FK_GIOHANG_TAIKHOAN FOREIGN KEY (TENDN) REFERENCES TAIKHOAN(TENDN);

ALTER TABLE HOADON ADD CONSTRAINT FK_HOADON_TAIKHOAN FOREIGN KEY (TENDN) REFERENCES TAIKHOAN(TENDN);
ALTER TABLE HOADON ADD CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH);

ALTER TABLE CHITIETHOADON ADD CONSTRAINT FK_HOADON_CHITIETHOADON FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD);

ALTER TABLE TAIKHOAN ADD CONSTRAINT FK_TAIKHOAN_CHUCVU FOREIGN KEY (MACV) REFERENCES CHUCVU(MACV);


INSERT INTO LOAIHANG VALUES
	(N'TN', N'Tai nghe'),
	(N'CSDP', N'Cục sạc dự phòng'),
	(N'BP', N'Bàn phím'),
	(N'LC', N'Lót chuột'),
	(N'GDLT', N'Giá đỡ laptop')

INSERT INTO HANG VALUES 
	(N'SS', N'SAMSUNG'),
	(N'SN', N'SONY'),
	(N'AP', N'APPLE'),
	(N'TSB', N'TOSHIBA'),
	(N'RZ', N'RAZER')


INSERT INTO SANPHAM VALUES
	(N'SP01', N'Tai nghe AirPod siêu cấp vip pro', N'TN', N'AP', 1000000, 1200000, CAST('7-10-2022' AS DATE), 'TN.PNG', ''),
	(N'SP02', N'Cục sạc dự phòng siêu cấp vip pro Sony', N'CSDP', N'SN', 300000, 400000, CAST('7-11-2020' AS DATE), 'TN.PNG', ''),
	(N'SP03', N'Bàn phím siêu cấp vip pro RAZER', N'BP', N'RZ', 800000, 1000000, CAST('12-1-2020' AS DATE), 'TN.PNG', ''),
	(N'SP04', N'Lót chuột siêu cấp vip pro in hình idol Đạt Villa', N'LC', N'TSB', 30000, 50000, CAST('7-7-2022' AS DATE), 'TN.PNG', ''),
	(N'SP05', N'Giá đỡ laptop siêu cấp vip pro bằng sứ', N'GDLT', N'SN', 500000, 600000, CAST('10-11-2022' AS DATE), 'TN.PNG', '')

INSERT INTO CHUCVU VALUES 
	(0, N'Quản lí'),
	(1, N'Nhân viên')


INSERT INTO TAIKHOAN VALUES
	(N'DangTH', 0, N'Trần Hữu Đang', 'dangthpc04349@gmail.com', '123', 'Vĩnh Long', '0123654987', CAST('7-9-2003' AS DATE), 1, 0),
	(N'VinhPQ', 1, N'Phùng Quốc Vinh', 'vinhpqpc04338@gmail.com', '123', 'Cần Thơ', '0123654987', CAST('5-11-2002' AS DATE), 1, 0),
	(N'DanNK', 1, N'Nguyễn Khánh Đan', 'dannkpc04351@gmail.com', '123', 'Cần Thơ', '0123654987', CAST('7-11-2022' AS DATE), 0, 1),
	(N'SyDH', 1, N'Đoàn Hiệp Sỹ', 'sydhpc04388@gmail.com', '123', 'An Giang', '0123654987', CAST('7-4-2003' AS DATE), 1, 0),
	(N'ViLB', 1, N'Lê Bích Vi', 'vilbpc04354@gmail.com', '123', 'Cà Mau', '0123654987', CAST('2-6-2003' AS DATE), 0, 1)
	
INSERT INTO KHACHHANG VALUES
	(N'DarkTH', N'Trần Hũ Dark', '0123456789', 'Vĩnh Long', 0),
	(N'DinhPQ', N'Phùng Quắk Dinh', '0123456789', 'Cần Thơ', 0),
	(N'DenNK', N'Nguyễn Khánk Đen', '0123456789', 'Cần Thơ', 0),
	(N'PeppaD', N'Đoàn Peppa', '0123456789', 'An Giang', 0),
	(N'DeLB', N'Lê Bíck De', '0123456789', 'Cà Mau', 0)

INSERT INTO GIOHANG VALUES 
	(N'GH01', N'SP01', N'DarkTH', N'VinhPQ', 1, 1200000),
	(N'GH02', N'SP02', N'DinhPQ', N'VinhPQ', 1, 400000),
	(N'GH03', N'SP01', N'DenNK', N'DanNK', 1, 1200000),
	(N'GH04', N'SP04', N'PeppaD', N'DanNK', 1, 50000),
	(N'GH05', N'SP01', N'DeLB', N'SyDH', 2, 2400000)

	INSERT INTO HOADON VALUES
	(N'HD01', N'VinhPQ', N'DarkTH', N'GH01', N'Tai nghe AirPod siêu cấp vip pro', CAST('6-10-2022' AS DATE), 1, 1200000, 1200000, 0, 0, 1200000, 1500000, 300000),
	(N'HD02', N'VinhPQ', N'DinhPQ', N'GH02', N'Cục sạc dự phòng siêu cấp vip pro Sony', CAST('7-11-2022' AS DATE), 1, 400000, 400000, 0, 0, 400000, 500000, 100000),
	(N'HD03', N'DanNK', N'DenNK', N'GH03', N'Tai nghe AirPod siêu cấp vip pro', CAST('7-11-2022' AS DATE), 1, 1200000, 1200000, 0, 0, 1200000, 1500000, 300000),
	(N'HD04', N'DanNK', N'PeppaD', N'GH04', N'Lót chuột siêu cấp vip pro in hình idol Đạt Villa', CAST('8-11-2022' AS DATE), 1, 50000, 50000, 0, 0, 50000, 100000, 50000),
	(N'HD05', N'SyDH', N'DeLB',N'GH05', N'Tai nghe AirPod siêu cấp vip pro', CAST('9-11-2022' AS DATE), 2, 1200000, 2400000, 0, 0, 2400000, 3000000, 600000)

INSERT INTO CHITIETHOADON VALUES
	(N'HD01', N'SP01', 'AP', 'TN', CAST('6-10-2022' AS DATE), N'Tai nghe AirPod siêu cấp vip pro', 'APPLE', 'Tai nghe', CAST('7-10-2022' AS DATE), 1000000, 1200000, 1, 0, 0),
	(N'HD02', N'SP02', 'SN', 'CSDP', CAST('7-11-2022' AS DATE), N'Cục sạc dự phòng siêu cấp vip pro Sony', 'SONY', 'Cục sạc dự phòng', CAST('7-11-2022' AS DATE), 300000, 400000, 1, 0, 0),
	(N'HD03', N'SP01', 'AP', 'TN', CAST('7-11-2022' AS DATE), N'Tai nghe AirPod siêu cấp vip pro', 'APPLE', 'Tai nghe', CAST('7-10-2022' AS DATE), 1000000, 1200000, 1, 0, 0),
	(N'HD04', N'SP04', 'AP', 'TN', CAST('8-11-2022' AS DATE), N'Lót chuột siêu cấp vip pro in hình idol Đạt Villa', 'TOSHIBA', 'Lót chuột', CAST('7-10-2022' AS DATE), 30000, 40000, 1, 0, 0),
	(N'HD05', N'SP01', 'AP', 'TN', CAST('9-11-2022' AS DATE), N'Tai nghe AirPod siêu cấp vip pro', 'APPLE', 'Tai nghe', CAST('7-10-2022' AS DATE), 1000000, 1200000, 2, 0, 0)

/* SELECT * FROM SANPHAM
SELECT * FROM LOAIHANG
SELECT * FROM NHANVIEN
SELECT * FROM KHACHHANG
SELECT * FROM HOADON
SELECT * FROM GIOHANG
SELECT * FROM HOADONCHITIET */

-- DROP PROC sp_NHANVIENSX
CREATE PROC sp_NHANVIENSX
AS BEGIN
	SELECT 
		HD.TENDN,
		COUNT(HD.MAHD) SL
	FROM HOADON HD JOIN TAIKHOAN NV ON NV.TENDN = HD.TENDN
	WHERE NV.TENDN = HD.TENDN

	GROUP BY HD.TENDN
	ORDER BY SL DESC
END
GO

--EXEC sp_NHANVIENSX

--DROP PROC sp_ThongKeDoanhThu_NAM
CREATE PROC sp_ThongKeDoanhThu_NAM (@Day INT, @Month INT, @Year INT)
AS BEGIN
	SELECT
		HD.MAHD,
		HD.NGAYLAP,
		HD.TENDN,
		HD.THANHTIEN
	FROM HOADON HD
		WHERE YEAR(NGAYLAP) = @Year AND MONTH(NGAYLAP) = @Month AND DAY(NGAYLAP) = @Day
END
GO

EXEC sp_ThongKeDoanhThu_NAM  '11', '7', '2022'


--DROP PROC sp_ThongKeDoanhThu_SP
CREATE PROC sp_ThongKeDoanhThu_SP
AS BEGIN
	SELECT
		SP.MASP,
		SP.TENSP,
		COUNT(HD.MAHD) LUOTBAN
	FROM HOADON HD
	JOIN CHITIETHOADON CTHD ON HD.MAHD = CTHD.MAHD
	JOIN SANPHAM SP ON SP.MASP = CTHD.MASP
		WHERE HD.MAHD = CTHD.MAHD AND SP.MASP = CTHD.MASP
		GROUP BY SP.MASP, SP.TENSP
		ORDER BY LUOTBAN DESC
END
GO

--EXEC sp_ThongKeDoanhThu_SP




